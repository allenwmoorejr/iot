apiVersion: batch/v1
kind: Job
metadata:
  name: homebridge-backup-now
  namespace: suite
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: backup-now
          image: alpine:3.20
          command: ["/bin/sh","-lc"]
          args:
            - |
              set -eux
              ts=$(date +%Y%m%d-%H%M%S)
              tar -czf /backups/homebridge-$ts.tgz -C /homebridge .
              echo "Wrote /backups/homebridge-$ts.tgz"
          volumeMounts:
            - { name: hb, mountPath: /homebridge }
            - { name: bkp, mountPath: /backups }
      volumes:
        - { name: hb,  persistentVolumeClaim: { claimName: homebridge-data-longhorn } }
        - { name: bkp, persistentVolumeClaim: { claimName: homebridge-backups-longhorn } }
