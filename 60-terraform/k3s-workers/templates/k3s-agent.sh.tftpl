#!/bin/bash
set -euxo pipefail

yum update -y

yum install -y curl

# Harden SSH: disable password authentication
sed -i 's/^PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
echo "ClientAliveInterval 120" >> /etc/ssh/sshd_config
echo "ClientAliveCountMax 2" >> /etc/ssh/sshd_config
systemctl restart sshd

curl -sfL https://get.k3s.io | \
  INSTALL_K3S_EXEC="--node-name ${node_name} --node-label location=aws" \
  K3S_URL="${k3s_url}" \
  K3S_TOKEN="${k3s_token}" \
  sh -
